<?xml version="1.0" encoding="UTF-8" ?>
<Module>
	<ModulePrefs title="Call Trace" description="Call Trace gadget"
		author="Jeff Yu" author_email="jeff.yuchang@gmail.com">
		<Require feature="setprefs" />
	</ModulePrefs>
	<UserPref name="serviceUrl" display_name="Service URL:"
		default_value="http://localhost:8080/overlord-bam/acm/query" />
	<UserPref name="refreshCycle" display_name="Refresh Interval(sec):"
		default_value="30" datatype="enum">
		<EnumValue value="30" />
		<EnumValue value="60" />
		<EnumValue value="120" />
		<EnumValue value="180" />
		<EnumValue value="300" />
	</UserPref>

	<Content type="html"><![CDATA[
	<style type="text/css">
		#tree {width:45%;float:left;}
		#detail {float:right;border:1px solid black; width:50%;}
		.tb-row {border:1px solid #98BF21;}
   </style>
   
	<link href="skin/ui.dynatree.css" rel="stylesheet" type="text/css">
	<script type="text/javascript" src="jquery.min.js"></script>
	<script type="text/javascript" src="jquery.cookie.js"></script>
	<script type="text/javascript" src="jquery-ui.custom.min.js"></script>
	<script type="text/javascript" src="jquery.dynatree.min.js"></script>
   
   <script type="text/javascript">
	
	function makeJSONRequest(){
	    var restUrl = "http://localhost:8080/gadgets/calltrace-gadget/calltrace.json";
		var params = {};
		var prefs = new gadgets.Prefs();
		params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.JSON;
		params[gadgets.io.RequestParameters.REFRESH_INTERVAL] = prefs.getInt("refreshCycle");
		params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;
   		
   		gadgets.io.makeRequest(restUrl, updateResponse, params);
	}
	
	function updateResponse(response) {
		var data = response.data;
	   	var treeData = new Array(data.tasks.length);
	   	for(var i = 0; i < treeData.length; i++) {
	   		var task = data.tasks[i];
	   		treeData[i] = convertJsonToTreeData(task);
	   	}
	
	   	initialiseTree(treeData);
	   	$("#detail").hide();
	}
	
	  function convertJsonToTreeData(task) {
  	    var treeObject = {};
  		var isCall = (task.type == "Call");
  		if (isCall) {
  			treeObject["title"] = task.component + " " + task.operation + " [" + task.duration + " ms] (" + task.percentage + "%)";
  			treeObject["isFolder"] = true;
  			treeObject["request"] = task.request;
  			treeObject["response"] = task.response;
  			treeObject["fault"] = task.fault;
  			treeObject['component'] = task.component;
  			treeObject['operation'] = task.operation;
  			treeObject['duration'] = task.duration;
  			treeObject['percentage'] = task.percentage;
  			treeObject['type'] = task.type;

  		} else {
  			treeObject["title"] = task.description + " [" + task.duration + "ms] (" + task.percentage + "%)";
  			treeObject["isFolder"] = false;
  			treeObject['description'] = task.description;
  			treeObject['duration'] = task.duration;
  			treeObject['percentage'] = task.percentage;
  			treeObject['type'] = task.type;
  		}

  		if (task.tasks != undefined) {
  			var children = new Array(task.tasks.length);
  			for (var i = 0; i < task.tasks.length; i++) {
  				var theTask = task.tasks[i];
  				children[i] = convertJsonToTreeData(theTask);
  			}
  			treeObject["children"] = children;
  		}
  		return treeObject;

  }

	  function initialiseTree(data) {	  	
	    // Attach the dynatree widget to an existing <div id="tree"> element
	    // and pass the tree options as an argument to the dynatree() function:
	  	$("#tree").dynatree({
	  		onActivate: function(node) {showTheDetail(node);},
	  		children: data
	  	});
	  }
	
	  function showTheDetail(node) {
	  	  $("#detail").show();
	  	  var properties = ['type', 'component', 'operation', 'request', 'response', 'requestLatency', 'responseLatency', 'duration', 'percentage'];
	  	  var thedata = node.data;
	  	  deleteRows();
	  	  for(i = 0; i < properties.length; i++) {
	  	  	var theProperty = properties[i];
	  	  	if (thedata[theProperty] != undefined) {
	  	  		insertRow([theProperty + " :" , thedata[theProperty]]);
	  	  	}
	  	  }
	  }
	
	   function deleteRows() {
			var theBody, theSize, i;
			theBody = document.getElementById("detail-body");
			theSize = theBody.rows.length;
			for (i = 0; i < theSize; i++) {
				theBody.deleteRow(theBody.rows[i]);
			}
		}

	function insertRow(data) {
		var theBody, theRow, theCell, i;
		theBody = document.getElementById("detail-body");
		theRow = document.createElement("TR");
		theRow.setAttribute("class", "tb-row");
		theBody.appendChild(theRow);
		for (i = 0; i < data.length; i++) {
			theCell = document.createElement("TD");
			theCell.innerHTML = data[i];
			theRow.appendChild(theCell);
		}
	}
	
	function loadData() {
         var prefs, refreshInterval;
         prefs = new gadgets.Prefs();
         refreshInterval = prefs.getInt("refreshCycle")
         makeJSONRequest();
         setInterval(makeJSONRequest, refreshInterval * 1000);
    }

    gadgets.util.registerOnLoadHandler(loadData);

   </script>
   
  	<div id="tree"></div>
  	<div id="detail">
		<table style="width:100%" border="0" cellspacing="3" cellpadding="5">
			<tbody id="detail-body">						
			</tbody>
	   </table>
  	</div>
]]>
	</Content>
</Module>
